{% comment %}
  Leadcod Form - Field Rendering Functions
  Functions to render different field types
{% endcomment %}
<script>
(function() {
  if (!window.LeadcodFormFields) {
    window.LeadcodFormFields = {};
  }

  const Utils = window.LeadcodFormUtils;

  window.LeadcodFormFields.renderField = function(field, settings) {
    const globalFontSize = Utils.getGlobalFontSize(settings);
    const globalFontWeight = Utils.getGlobalFontWeight(settings);
    const globalFontStyle = Utils.getGlobalFontStyle(settings);
    const primaryColor = Utils.getPrimaryColor(settings);
    const iconSize = Utils.calculateIconSize(globalFontSize, settings);
    
    const inputAlignment = field.inputAlignment || 'left';

    const inputStyle = `
      font-family: ${Utils.getFontFamily(settings)}; font-size: ${globalFontSize}; text-align: ${inputAlignment};
      color: ${field.inputTextColor || '#000000'};
      background-color: ${field.inputBackgroundColor || '#ffffff'};
      padding: ${Utils.calculatePadding(globalFontSize, settings)};
      height: ${Utils.calculateHeight(globalFontSize, settings)};
      min-height: ${Utils.calculateHeight(globalFontSize, settings)};
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      width: 100%;
      box-sizing: border-box;
    `;

    const labelAlignment = field.labelAlignment || 'left';
    
    // Determine icon position based on label alignment
    // left -> icon on left, right -> icon on right, center -> icon on right (default)
    const iconOnLeft = labelAlignment === 'left';
    const iconOnRight = labelAlignment === 'right' || labelAlignment === 'center';
    
    // Icon style function - border radius depends on position (left or right)
    const getIconStyle = function(onLeft) {
      if (onLeft) {
        return `
          font-family: ${Utils.getFontFamily(settings)};
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          height: ${Utils.calculateHeight(globalFontSize, settings)};
          min-height: ${Utils.calculateHeight(globalFontSize, settings)};
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 12px;
          border: 1px solid #e5e7eb;
          border-right: none;
          border-radius: 0.375rem 0 0 0.375rem;
          background-color: #f3f4f6;
        `;
      } else {
        return `
          font-family: ${Utils.getFontFamily(settings)};
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          height: ${Utils.calculateHeight(globalFontSize, settings)};
          min-height: ${Utils.calculateHeight(globalFontSize, settings)};
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 12px;
          border: 1px solid #e5e7eb;
          border-left: none;
          border-radius: 0 0.375rem 0.375rem 0;
          background-color: #f3f4f6;
        `;
      }
    };

    const labelStyle = `
      font-family: ${Utils.getFontFamily(settings)}; font-size: ${globalFontSize}; font-weight: ${globalFontWeight}; font-style: ${globalFontStyle}; text-align: ${labelAlignment};
      color: ${primaryColor};
      display: block;
      margin-bottom: 4px;
    `;

    let fieldHTML = '<div class="leadcod-field" style="margin-bottom: 4px;">';

    // Label
    if (field.showLabel) {
      fieldHTML += `<label style="${labelStyle}">${field.label}${field.required ? ' <span style="color: #ef4444;">*</span>' : ''}</label>`;
    }

    // Input wrapper
    fieldHTML += `<div style="display: flex; align-items: stretch;">`;

    switch (field.type) {
      case 'name':
      case 'city':
      case 'email':
        // Input border radius - depends on icon position
        const inputBorderRadius = Utils.renderIcon(field.icon, iconSize) 
          ? (iconOnLeft 
              ? 'border-left: none; border-radius: 0 0.375rem 0.375rem 0;'
              : 'border-right: none; border-radius: 0.375rem 0 0 0.375rem;')
          : 'border-radius: 0.375rem;';
        fieldHTML += `
          ${Utils.renderIcon(field.icon, iconSize) && iconOnLeft ? `<div style="${getIconStyle(true)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
          <input 
            type="${field.type === 'email' ? 'email' : 'text'}" 
            placeholder="${field.showPlaceholder ? field.placeholder : ''}" 
            style="${inputStyle} ${inputBorderRadius}"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
          />
          ${Utils.renderIcon(field.icon, iconSize) && iconOnRight ? `<div style="${getIconStyle(false)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
        `;
        break;

      case 'phone':
        // Phone field is special: +213 follows label position, icon is opposite
        const phoneCodeOnLeft = labelAlignment === 'left';
        const phoneCodeOnRight = labelAlignment === 'right' || labelAlignment === 'center';
        const phoneIconOnLeft = !phoneCodeOnLeft; // Opposite of code position
        const phoneIconOnRight = !phoneCodeOnRight; // Opposite of code position
        
        const phoneInputBorder = 'border-left: none; border-right: none; border-radius: 0;';
        fieldHTML += `
          ${phoneCodeOnLeft ? `<div style="${getIconStyle(true)}">+213</div>` : ''}
          ${Utils.renderIcon(field.icon, iconSize) && phoneIconOnLeft ? `<div style="${getIconStyle(true)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
          <input 
            type="tel" 
            placeholder="${field.showPlaceholder ? field.placeholder : ''}" 
            style="${inputStyle} ${phoneInputBorder}"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
          />
          ${Utils.renderIcon(field.icon, iconSize) && phoneIconOnRight ? `<div style="${getIconStyle(false)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
          ${phoneCodeOnRight ? `<div style="${getIconStyle(false)}">+213</div>` : ''}
        `;
        break;

      case 'province':
        // Select border radius - depends on icon position
        const provinceSelectBorder = Utils.renderIcon(field.icon, iconSize) 
          ? (iconOnLeft 
              ? 'border-left: none; border-radius: 0 0.375rem 0.375rem 0;'
              : 'border-right: none; border-radius: 0.375rem 0 0 0.375rem;')
          : 'border-radius: 0.375rem;';
        const provinceSelectArrowPos = 'right 12px';
        const provinceSelectPadding = 'padding-right: 32px;';
        const provinceSelectStyle = `${inputStyle} background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: ${provinceSelectArrowPos} center; ${provinceSelectPadding} -webkit-appearance: none; -moz-appearance: none; appearance: none; ${provinceSelectBorder}`;
        fieldHTML += `
          ${Utils.renderIcon(field.icon, iconSize) && iconOnLeft ? `<div style="${getIconStyle(true)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
          <select 
            style="${provinceSelectStyle}"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
          >
            <option value="">${field.showPlaceholder ? field.placeholder : 'Select'}</option>
            <option value="ontario">Ontario</option>
            <option value="quebec">Quebec</option>
            <option value="british-columbia">British Columbia</option>
            <option value="alberta">Alberta</option>
            <option value="manitoba">Manitoba</option>
            <option value="saskatchewan">Saskatchewan</option>
          </select>
          ${Utils.renderIcon(field.icon, iconSize) && iconOnRight ? `<div style="${getIconStyle(false)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
        `;
        break;

      case 'variants':
        // Select border radius - depends on icon position
        const variantsSelectBorder = Utils.renderIcon(field.icon, iconSize) 
          ? (iconOnLeft 
              ? 'border-left: none; border-radius: 0 0.375rem 0.375rem 0;'
              : 'border-right: none; border-radius: 0.375rem 0 0 0.375rem;')
          : 'border-radius: 0.375rem;';
        const variantsSelectArrowPos = 'right 12px';
        const variantsSelectPadding = 'padding-right: 32px;';
        const variantsSelectStyle = `${inputStyle} background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: ${variantsSelectArrowPos} center; ${variantsSelectPadding} -webkit-appearance: none; -moz-appearance: none; appearance: none; ${variantsSelectBorder}`;
        fieldHTML += `
          ${Utils.renderIcon(field.icon, iconSize) && iconOnLeft ? `<div style="${getIconStyle(true)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
          <select 
            style="${variantsSelectStyle}"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
          >
            <option value="">${field.showPlaceholder ? field.placeholder : 'Select'}</option>
            <option value="small">Size: Small</option>
            <option value="medium">Size: Medium</option>
            <option value="large">Size: Large</option>
          </select>
          ${Utils.renderIcon(field.icon, iconSize) && iconOnRight ? `<div style="${getIconStyle(false)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
        `;
        break;

      case 'quantity':
        // Input border radius - depends on icon position
        const quantityBorderRadius = Utils.renderIcon(field.icon, iconSize) 
          ? (iconOnLeft 
              ? 'border-left: none; border-radius: 0 0.375rem 0.375rem 0;'
              : 'border-right: none; border-radius: 0.375rem 0 0 0.375rem;')
          : 'border-radius: 0.375rem;';
        fieldHTML += `
          ${Utils.renderIcon(field.icon, iconSize) && iconOnLeft ? `<div style="${getIconStyle(true)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
          <input 
            type="number" 
            min="1" 
            value="1"
            placeholder="${field.showPlaceholder ? field.placeholder : ''}" 
            style="${inputStyle} ${quantityBorderRadius}"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
          />
          ${Utils.renderIcon(field.icon, iconSize) && iconOnRight ? `<div style="${getIconStyle(false)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
        `;
        break;

      case 'coupon':
        // Input border radius - depends on icon position
        const couponInputBorder = Utils.renderIcon(field.icon, iconSize) 
          ? (iconOnLeft 
              ? 'border-left: none; border-radius: 0 0.375rem 0.375rem 0;'
              : 'border-right: none; border-radius: 0.375rem 0 0 0.375rem;')
          : 'border-radius: 0.375rem;';
        fieldHTML += `
          <div style="display: flex; gap: 8px; width: 100%;">
            <div style="display: flex; flex: 1;">
              ${Utils.renderIcon(field.icon, iconSize) && iconOnLeft ? `<div style="${getIconStyle(true)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
              <input 
                type="text" 
                placeholder="${field.showPlaceholder ? field.placeholder : ''}" 
                style="${inputStyle} ${couponInputBorder}"
                ${field.required ? 'required' : ''}
                name="${field.id}"
                id="field-${field.id}"
              />
              ${Utils.renderIcon(field.icon, iconSize) && iconOnRight ? `<div style="${getIconStyle(false)}">${Utils.renderIcon(field.icon, iconSize)}</div>` : ''}
            </div>
            <button type="button" style="padding: 0 20px; border: 1px solid #e5e7eb; border-radius: 0.375rem; background: #f9fafb; cursor: pointer;">Apply</button>
          </div>
        `;
        break;

      case 'summary':
        const summaryStyle = `
          font-family: ${Utils.getFontFamily(settings)};
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          background-color: #f9fafb;
          border: 2px solid #e5e7eb;
          border-radius: 0.375rem;
          padding: 16px;
        `;
        const summaryTitleStyle = `
          font-family: ${Utils.getFontFamily(settings)};
          font-size: ${globalFontSize};
          font-weight: bold;
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          margin: 0 0 12px 0;
        `;
        const summaryItemStyle = `
          font-family: ${Utils.getFontFamily(settings)};
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
        `;
        fieldHTML = `
          <div class="leadcod-field" style="margin-bottom: 4px;">
            <div style="${summaryStyle}">
              <h3 style="${summaryTitleStyle}">
                ${field.showLabel ? field.label : 'Summary'}
              </h3>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; ${summaryItemStyle}">
                <span style="color: #6b7280;">Subtotal:</span>
                <span style="font-weight: 500;">$99.99</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; ${summaryItemStyle}">
                <span style="color: #6b7280;">Shipping:</span>
                <span style="font-weight: 500;">$10.00</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; ${summaryItemStyle}">
                <span style="color: #6b7280;">Tax:</span>
                <span style="font-weight: 500;">$14.00</span>
              </div>
              <div style="border-top: 1px solid #e5e7eb; padding-top: 12px; margin-top: 12px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="font-family: ${Utils.getFontFamily(settings)}; font-size: ${globalFontSize}; font-weight: 600; font-style: ${globalFontStyle}; color: ${primaryColor};">Total:</span>
                  <span style="font-family: ${Utils.getFontFamily(settings)}; font-size: ${parseInt(globalFontSize.replace('px', '')) + 4}px; font-weight: 700; font-style: ${globalFontStyle}; color: ${primaryColor};">$123.99</span>
                </div>
              </div>
            </div>
          </div>
        `;
        return fieldHTML;

      case 'buyButton':
        return window.LeadcodFormFields.renderBuyButton(field, settings);
    }

    fieldHTML += '</div></div>';
    return fieldHTML;
  };

  window.LeadcodFormFields.renderBuyButton = function(field, settings) {
    const Utils = window.LeadcodFormUtils;
    const buttonGlobalFontSize = Utils.getGlobalFontSize(settings);
    const buttonGlobalFontStyle = Utils.getGlobalFontStyle(settings);
    
    // Use button-specific font size if available, otherwise fall back to global
    const buttonFontSize = field.buttonFontSize || buttonGlobalFontSize;
    
    const buttonPadding = (() => {
      const fontSizeNum = parseInt(buttonFontSize.replace('px', '')) || 16;
      const verticalPadding = Math.max(10, Math.round(fontSizeNum * 0.625));
      const horizontalPadding = Math.max(20, Math.round(fontSizeNum * 1.5));
      return `${verticalPadding}px ${horizontalPadding}px`;
    })();

    const buttonSize = field.buttonSize === 'extra-large' ? '56px' : 
                      field.buttonSize === 'large' ? '48px' : 
                      field.buttonSize === 'small' ? '32px' : '40px';
    
    const buttonHeightNum = parseInt(buttonSize.replace('px', '')) || 40;
    // Use button-specific icon size if available, otherwise calculate from button height
    const buttonIconSize = field.buttonIconSize || Math.round(buttonHeightNum * 0.6);

    let buttonStyle = `
      font-family: ${Utils.getFontFamily(settings)}; font-size: ${buttonFontSize}; font-weight: bold; font-style: ${buttonGlobalFontStyle}; text-align: ${Utils.getTextAlign(field.inputAlignment || 'center')};
      color: ${field.inputTextColor || '#ffffff'};
      padding: ${buttonPadding};
      height: ${buttonSize};
      border: none;
      border-radius: 0.375rem;
      width: 100%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    `;

    // Set glow color CSS variable if glow animation is active
    if (field.animation === 'glow') {
      const glowColor = Utils.extractGlowColor(field);
      let rgbaColor = glowColor;
      if (glowColor.startsWith('#')) {
        const hex = glowColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        rgbaColor = `rgba(${r}, ${g}, ${b}, 0.6)`;
      } else if (glowColor.startsWith('rgb(')) {
        rgbaColor = glowColor.replace('rgb(', 'rgba(').replace(')', ', 0.6)');
      } else if (!glowColor.startsWith('rgba(')) {
        rgbaColor = `rgba(0, 0, 0, 0.3)`;
      }
      buttonStyle += `--glow-color: ${rgbaColor};`;
    }

    // Set background properties
    if (field.backgroundType === 'gradient' && field.gradientBackground) {
      // For gradients with background-shift, use the gradient directly without overlay
      if (field.animation === 'background-shift') {
        buttonStyle += `background-image: ${field.gradientBackground}; background-size: 200% 200% !important;`;
      } else {
        buttonStyle += `background-image: ${field.gradientBackground};`;
      }
    } else {
      const solidColor = field.inputBackgroundColor || '#000000';
      // For background-shift animation with solid colors, convert to gradient with transparency
      if (field.animation === 'background-shift') {
        // Check if color is black or very dark (to handle black specifically)
        const hex = solidColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        const isDark = r < 30 && g < 30 && b < 30;
        
        if (isDark) {
          // For black/dark colors, use visible gray variations that keep black as base
          const rgbaBase = Utils.colorToRgba(solidColor, 1);
          const rgbaMid = Utils.colorToRgba('#404040', 1);
          const rgbaLight = Utils.colorToRgba('#606060', 1);
          buttonStyle += `background-image: linear-gradient(135deg, ${rgbaBase} 0%, ${rgbaMid} 25%, ${rgbaLight} 50%, ${rgbaMid} 75%, ${rgbaBase} 100%); background-size: 200% 200% !important;`;
        } else {
          // For lighter colors, make base color more prominent with less aggressive shift
          const lighterColor = Utils.lightenColor(solidColor, 25);
          const rgbaBase = Utils.colorToRgba(solidColor, 1);
          const rgbaLight = Utils.colorToRgba(lighterColor, 0.8);
          const rgbaSemiTransparent = Utils.colorToRgba(solidColor, 0.7);
          buttonStyle += `background-image: linear-gradient(135deg, ${rgbaBase} 0%, ${rgbaSemiTransparent} 25%, ${rgbaLight} 50%, ${rgbaSemiTransparent} 75%, ${rgbaBase} 100%); background-size: 200% 200% !important;`;
        }
      } else {
        buttonStyle += `background-color: ${solidColor};`;
      }
    }

    // Add animation classes with proper priority and performance optimizations
    if (field.animation === 'background-shift') {
      buttonStyle += `animation: backgroundShift 4s ease infinite !important; will-change: background-position;`;
    } else if (field.animation === 'shake') {
      buttonStyle += `animation: shake 0.6s ease-in-out infinite !important; will-change: transform; transform-origin: center;`;
    } else if (field.animation === 'bounce') {
      buttonStyle += `animation: bounce 1s ease-in-out infinite !important; will-change: transform; transform-origin: center;`;
    } else if (field.animation === 'pulse') {
      buttonStyle += `animation: pulse 2s ease-in-out infinite !important; will-change: transform, opacity; transform-origin: center;`;
    } else if (field.animation === 'glow') {
      buttonStyle += `animation: glow 2s ease-in-out infinite !important; will-change: box-shadow;`;
    }

    return `
      <div class="leadcod-field" style="margin-bottom: 4px;">
        <button type="submit" style="${buttonStyle}">
          ${Utils.renderIcon(field.icon, buttonIconSize, true)}
          ${field.label}
        </button>
      </div>
    `;
  };
})();
</script>

