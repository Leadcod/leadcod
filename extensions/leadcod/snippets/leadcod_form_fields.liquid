<script>
(function() {
  'use strict';

  if (!window.LeadcodFormFields) {
    window.LeadcodFormFields = {};
  }

  const Utils = window.LeadcodFormUtils;

  window.LeadcodFormFields.renderField = function(field, settings, shippingSettings) {
    const globalFontSize = Utils.getGlobalFontSize(settings);
    const globalFontWeight = Utils.getGlobalFontWeight(settings);
    const globalFontStyle = Utils.getGlobalFontStyle(settings);
    const primaryColor = Utils.getPrimaryColor(settings);
    
    const fieldFontFamily = Utils.getFontFamily(settings);
    
    const iconSize = Utils.calculateIconSize(globalFontSize, settings);
    const inputAlignment = field.inputAlignment || 'right';

    const inputStyle = `
      font-family: ${fieldFontFamily} !important;
      font-size: ${globalFontSize};
      font-weight: normal !important;
      font-style: normal !important;
      text-align: ${inputAlignment};
      color: ${field.inputTextColor || '#000000'};
      background-color: ${field.inputBackgroundColor || '#ffffff'};
      padding: ${Utils.calculatePadding(globalFontSize, settings)};
      height: ${Utils.calculateHeight(globalFontSize, settings)};
      min-height: ${Utils.calculateHeight(globalFontSize, settings)};
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
    `;

    const labelAlignment = field.labelAlignment || 'right';

    const iconOnLeft = labelAlignment === 'left';
    const iconOnRight = labelAlignment === 'right' || labelAlignment === 'center';

    const getIconStyle = function(onLeft) {
      if (onLeft) {
        return `
          font-family: ${fieldFontFamily} !important;
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          height: ${Utils.calculateHeight(globalFontSize, settings)};
          min-height: ${Utils.calculateHeight(globalFontSize, settings)};
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 12px;
          border: 1px solid #e5e7eb;
          border-right: none;
          border-radius: 8px 0 0 8px;
          background-color: #f3f4f6;
        `;
      } else {
        return `
          font-family: ${fieldFontFamily} !important;
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          height: ${Utils.calculateHeight(globalFontSize, settings)};
          min-height: ${Utils.calculateHeight(globalFontSize, settings)};
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 12px;
          border: 1px solid #e5e7eb;
          border-left: none;
          border-radius: 0 8px 8px 0;
          background-color: #f3f4f6;
        `;
      }
    };

    const labelStyle = `
      font-family: ${fieldFontFamily} !important;
      font-size: ${field.labelFontSize || '12px'};
      font-weight: ${globalFontWeight};
      font-style: ${globalFontStyle};
      color: ${field.labelColor || primaryColor || '#1f2937'};
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: ${labelAlignment === 'center' ? 'center' : labelAlignment === 'right' ? 'flex-end' : 'flex-start'};
      margin-bottom: 2px;
      margin-top: 0;
    `;

    let fieldHTML = '<div class="leadcod-field">';
    let isPhoneField = false;

    if (field.showLabel && field.type !== 'quantity') {
      const requiredIndicator = field.required ? ' <span style="color: #ef4444;">*</span>' : '';
      fieldHTML += `<label style="${labelStyle}">${field.label}${requiredIndicator}</label>`;
    }

    fieldHTML += '<div class="leadcod-input-wrapper" style="width: 100%; position: relative;">';

    switch (field.type) {
      case 'name':
      case 'email': {
        const hasIcon = Utils.renderIcon(field.icon, iconSize);
        const inputType = field.type === 'email' ? 'email' : 'text';
        const placeholder = field.showPlaceholder ? field.placeholder : '';
        const iconHTML = hasIcon ? Utils.renderIcon(field.icon, iconSize) : '';
        const basePadding = Utils.calculatePadding(globalFontSize, settings);
        const paddingParts = basePadding.split(' ');
        const horizontalPadding = paddingParts[1] || paddingParts[0] || '12px';

        fieldHTML += `
          ${hasIcon && iconOnLeft ? `<div style="${getIconStyle(true)}">${iconHTML}</div>` : ''}
          <input 
            type="${inputType}" 
            placeholder="${placeholder}" 
            style="${inputStyle} width: 100%; border-left: ${hasIcon && iconOnLeft ? 'none' : '1px solid #e5e7eb'}; border-right: ${hasIcon && iconOnRight ? 'none' : '1px solid #e5e7eb'}; border-radius: ${hasIcon && iconOnLeft ? '0 8px 8px 0' : hasIcon && iconOnRight ? '8px 0 0 8px' : '8px'};"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
          />
          ${hasIcon && iconOnRight ? `<div style="${getIconStyle(false)}">${iconHTML}</div>` : ''}
        `;
        break;
      }

      case 'city': {
        const hasIcon = Utils.renderIcon(field.icon, iconSize);
        const basePadding = Utils.calculatePadding(globalFontSize, settings);
        const paddingParts = basePadding.split(' ');
        const horizontalPadding = paddingParts[1] || paddingParts[0] || '12px';
        const arrowOnLeft = hasIcon && iconOnRight;
        const arrowOnRight = !hasIcon || iconOnLeft;
        const paddingLeft = hasIcon && iconOnLeft ? horizontalPadding : (arrowOnLeft ? '32px' : horizontalPadding);
        const paddingRight = hasIcon && iconOnRight ? horizontalPadding : (arrowOnRight ? '32px' : horizontalPadding);
        const arrowClass = arrowOnLeft ? 'leadcod-select-arrow-left' : 'leadcod-select-arrow-right';
        const citySelectStyle = `${inputStyle} font-weight: normal !important; font-style: normal !important; padding-top: 0; padding-bottom: 0; padding-left: ${paddingLeft}; padding-right: ${paddingRight}; -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 100%; border-left: ${hasIcon && iconOnLeft ? 'none !important' : '1px solid #e5e7eb'}; border-right: ${hasIcon && iconOnRight ? 'none !important' : '1px solid #e5e7eb'}; border-radius: ${hasIcon && iconOnLeft ? '0 8px 8px 0 !important' : hasIcon && iconOnRight ? '8px 0 0 8px !important' : '8px'};`;
        const placeholder = field.showPlaceholder ? field.placeholder : 'Select';
        const iconHTML = hasIcon ? Utils.renderIcon(field.icon, iconSize) : '';

        fieldHTML += `
          ${hasIcon && iconOnLeft ? `<div style="${getIconStyle(true)}">${iconHTML}</div>` : ''}
          <select 
            style="${citySelectStyle} opacity: 0.6; cursor: not-allowed; background-color: #f9fafb;"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
            class="leadcod-city-select ${arrowClass}${hasIcon && iconOnLeft ? ' leadcod-select-icon-left' : ''}${hasIcon && iconOnRight ? ' leadcod-select-icon-right' : ''}"
            data-placeholder="${placeholder}"
            disabled
          >
            <option value="">${placeholder}</option>
          </select>
          ${hasIcon && iconOnRight ? `<div style="${getIconStyle(false)}">${iconHTML}</div>` : ''}
        `;
        break;
      }

      case 'phone': {
        isPhoneField = true;
        const placeholder = field.showPlaceholder ? field.placeholder : '';
        const hasIcon = Utils.renderIcon(field.icon, iconSize);
        const iconHTML = hasIcon ? Utils.renderIcon(field.icon, iconSize) : '';
        const phoneCodeOnLeft = labelAlignment === 'left';
        const phoneCodeOnRight = labelAlignment === 'right' || labelAlignment === 'center';
        const phoneIconOnLeft = !phoneCodeOnLeft;
        const phoneIconOnRight = !phoneCodeOnRight;

        fieldHTML += `
          ${phoneCodeOnLeft ? `<div >+213</div>` : ''}
          ${hasIcon && phoneIconOnLeft ? `<div style="${getIconStyle(true)}">${iconHTML}</div>` : ''}
          <input 
            type="tel" 
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="10"
            placeholder="${placeholder}" 
            style="${inputStyle} width: 100%; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; border-radius: 0;"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
            class="leadcod-phone-input"
            data-field-id="${field.id}"
          />
          ${hasIcon && phoneIconOnRight ? `<div style="${getIconStyle(false)}">${iconHTML}</div>` : ''}
          ${phoneCodeOnRight ? `<div style="${getIconStyle(false)}">+213</div>` : ''}
        `;
        fieldHTML += '</div>'; // Close input wrapper
        fieldHTML += `<div class="leadcod-phone-error" id="error-${field.id}" style="display: none; color: #ef4444; font-size: 0.875rem; margin-top: 4px; text-align: ${inputAlignment};"></div>`;
        break;
      }

      case 'province': {
        const hasIcon = Utils.renderIcon(field.icon, iconSize);
        const basePadding = Utils.calculatePadding(globalFontSize, settings);
        const paddingParts = basePadding.split(' ');
        const horizontalPadding = paddingParts[1] || paddingParts[0] || '12px';
        const arrowOnLeft = hasIcon && iconOnRight;
        const arrowOnRight = !hasIcon || iconOnLeft;
        const paddingLeft = hasIcon && iconOnLeft ? horizontalPadding : (arrowOnLeft ? '32px' : horizontalPadding);
        const paddingRight = hasIcon && iconOnRight ? horizontalPadding : (arrowOnRight ? '32px' : horizontalPadding);
        const arrowClass = arrowOnLeft ? 'leadcod-select-arrow-left' : 'leadcod-select-arrow-right';
        const provinceSelectStyle = `${inputStyle} font-weight: normal !important; font-style: normal !important; padding-top: 0; padding-bottom: 0; padding-left: ${paddingLeft}; padding-right: ${paddingRight}; -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 100%; border-left: ${hasIcon && iconOnLeft ? 'none !important' : '1px solid #e5e7eb'}; border-right: ${hasIcon && iconOnRight ? 'none !important' : '1px solid #e5e7eb'}; border-radius: ${hasIcon && iconOnLeft ? '0 8px 8px 0 !important' : hasIcon && iconOnRight ? '8px 0 0 8px !important' : '8px'};`;
        const placeholder = field.showPlaceholder ? field.placeholder : 'Select';
        const iconHTML = hasIcon ? Utils.renderIcon(field.icon, iconSize) : '';

        fieldHTML += `
          ${hasIcon && iconOnLeft ? `<div style="${getIconStyle(true)}">${iconHTML}</div>` : ''}
          <select 
            style="${provinceSelectStyle} opacity: 0.6; cursor: not-allowed; background-color: #f9fafb;"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
            class="leadcod-province-select ${arrowClass}${hasIcon && iconOnLeft ? ' leadcod-select-icon-left' : ''}${hasIcon && iconOnRight ? ' leadcod-select-icon-right' : ''}"
            data-placeholder="${placeholder}"
            disabled
          >
            <option value="">${placeholder}</option>
          </select>
          ${hasIcon && iconOnRight ? `<div style="${getIconStyle(false)}">${iconHTML}</div>` : ''}
        `;
        break;
      }

      case 'variants': {
        const hasIcon = Utils.renderIcon(field.icon, iconSize);
        const basePadding = Utils.calculatePadding(globalFontSize, settings);
        const paddingParts = basePadding.split(' ');
        const horizontalPadding = paddingParts[1] || paddingParts[0] || '12px';
        const arrowOnLeft = hasIcon && iconOnRight;
        const arrowOnRight = !hasIcon || iconOnLeft;
        const paddingLeft = hasIcon && iconOnLeft ? horizontalPadding : (arrowOnLeft ? '32px' : horizontalPadding);
        const paddingRight = hasIcon && iconOnRight ? horizontalPadding : (arrowOnRight ? '32px' : horizontalPadding);
        const arrowClass = arrowOnLeft ? 'leadcod-select-arrow-left' : 'leadcod-select-arrow-right';
        const variantsSelectStyle = `${inputStyle} padding-top: 0; padding-bottom: 0; padding-left: ${paddingLeft}; padding-right: ${paddingRight}; -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 100%; border-left: ${hasIcon && iconOnLeft ? 'none !important' : '1px solid #e5e7eb'}; border-right: ${hasIcon && iconOnRight ? 'none !important' : '1px solid #e5e7eb'}; border-radius: ${hasIcon && iconOnLeft ? '0 8px 8px 0 !important' : hasIcon && iconOnRight ? '8px 0 0 8px !important' : '8px'};`;
        const placeholder = field.showPlaceholder ? field.placeholder : 'Select';
        const iconHTML = hasIcon ? Utils.renderIcon(field.icon, iconSize) : '';

        fieldHTML += `
          ${hasIcon && iconOnLeft ? `<div style="${getIconStyle(true)}">${iconHTML}</div>` : ''}
          <select 
            style="${variantsSelectStyle}"
            ${field.required ? 'required' : ''}
            name="${field.id}"
            id="field-${field.id}"
            class="${arrowClass}${hasIcon && iconOnLeft ? ' leadcod-select-icon-left' : ''}${hasIcon && iconOnRight ? ' leadcod-select-icon-right' : ''}"
          >
            <option value="">${placeholder}</option>
            <option value="small">الحجم: صغير</option>
            <option value="medium">الحجم: متوسط</option>
            <option value="large">الحجم: كبير</option>
          </select>
          ${hasIcon && iconOnRight ? `<div style="${getIconStyle(false)}">${iconHTML}</div>` : ''}
        `;
        break;
      }

      case 'quantity': {
        fieldHTML += `
          <div class="leadcod-quantity-selector" style="width: 100%;">
            <button type="button" class="leadcod-quantity-button" data-action="decrease" style="font-family: ${fieldFontFamily} !important;">-</button>
            <input 
              type="number" 
              name="${field.id}" 
              value="1" 
              min="1" 
              class="leadcod-quantity-value" 
              style="border: none; background: transparent; text-align: center; min-width: 60px; font-weight: 600; font-size: 18px; font-family: ${fieldFontFamily} !important; color: ${field.inputTextColor || '#000000'};"
              ${field.required ? 'required' : ''}
              id="field-${field.id}"
            />
            <button type="button" class="leadcod-quantity-button" data-action="increase" style="font-family: ${fieldFontFamily} !important;">+</button>
          </div>
        `;
        break;
      }

      case 'coupon': {
        const hasIcon = Utils.renderIcon(field.icon, iconSize);
        const placeholder = field.showPlaceholder ? field.placeholder : '';
        const iconHTML = hasIcon ? Utils.renderIcon(field.icon, iconSize) : '';

        fieldHTML += `
          <div style="display: flex; gap: 8px; width: 100%;">
            <div style="display: flex; flex: 1; position: relative;">
              ${hasIcon && iconOnLeft ? `<div style="${getIconStyle(true)}">${iconHTML}</div>` : ''}
              <input 
                type="text" 
                placeholder="${placeholder}" 
                style="${inputStyle} width: 100%; border-left: ${hasIcon && iconOnLeft ? 'none' : '1px solid #e5e7eb'}; border-right: ${hasIcon && iconOnRight ? 'none' : '1px solid #e5e7eb'}; border-radius: ${hasIcon && iconOnLeft ? '0 8px 8px 0' : hasIcon && iconOnRight ? '8px 0 0 8px' : '8px'};"
                ${field.required ? 'required' : ''}
                name="${field.id}"
                id="field-${field.id}"
              />
              ${hasIcon && iconOnRight ? `<div style="${getIconStyle(false)}">${iconHTML}</div>` : ''}
            </div>
            <button type="button" style="padding: 0 20px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; cursor: pointer; font-family: ${fieldFontFamily} !important; font-size: ${globalFontSize}; font-weight: ${globalFontWeight}; white-space: nowrap;">تطبيق</button>
          </div>
        `;
        break;
      }

      case 'summary': {
        const summaryPlaceholder = field.summaryPlaceholder || '-';
        const totalLabel = field.totalLabel || 'المجموع';
        const shippingLabel = field.shippingLabel || 'سعر الشحن';
        const chooseProvinceHint = field.chooseProvinceHint || 'اختر الولاية';
        const selectShippingOptionHint = field.selectShippingOptionHint || 'اختر خيار الشحن';
        const summaryAlignment = field.summaryAlignment || 'right';
        
        const summaryStyle = `
          font-family: ${Utils.getFontFamily(settings)} !important;
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          background-color: #f9fafb;
          border: 2px solid #e5e7eb;
          border-radius: 0.375rem;
          padding: 12px;
        `;
        const summaryItemStyle = `
          font-family: ${Utils.getFontFamily(settings)} !important;
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
        `;

        const globalFontFamily = Utils.getFontFamily(settings);
        fieldHTML = `
          <div class="leadcod-field" style="margin-bottom: 0;">
            <div class="leadcod-summary-section">
              <div class="leadcod-summary-content" style="display: block; text-align: ${summaryAlignment}; font-family: ${globalFontFamily} !important;">
                <div class="leadcod-summary-item" style="text-align: ${summaryAlignment}; font-family: ${globalFontFamily} !important;">
                  <span class="leadcod-summary-item-label leadcod-product-name" style="font-family: ${globalFontFamily} !important;">${summaryPlaceholder}</span>
                  <span class="leadcod-summary-item-value leadcod-product-price" style="font-family: ${globalFontFamily} !important;">${summaryPlaceholder}</span>
                </div>
                <div class="leadcod-summary-item" style="text-align: ${summaryAlignment}; font-family: ${globalFontFamily} !important;">
                  <div>
                    <div class="leadcod-summary-item-label leadcod-shipping-label" style="font-family: ${globalFontFamily} !important;">${shippingLabel}</div>
                    <div class="leadcod-shipping-hint" style="color: #6b7280; font-size: 12px; margin-top: 2px; display: flex; align-items: center; gap: 4px; font-family: ${globalFontFamily} !important;">
                      ${Utils.renderIcon('Globe', 14)}
                      <span class="leadcod-shipping-hint-text" style="font-family: ${globalFontFamily} !important;">${chooseProvinceHint}</span>
                    </div>
                  </div>
                  <span class="leadcod-summary-item-value leadcod-shipping-price" style="font-family: ${globalFontFamily} !important;">${summaryPlaceholder}</span>
                </div>
                <div class="leadcod-dotted-separator"></div>
                <div class="leadcod-summary-total" style="text-align: ${summaryAlignment}; font-family: ${globalFontFamily} !important;">
                  <div>
                    <div class="leadcod-summary-total-label" style="font-family: ${globalFontFamily} !important;">${totalLabel}</div>
                  </div>
                  <span class="leadcod-summary-total-value leadcod-total-price" style="font-family: ${globalFontFamily} !important;">${summaryPlaceholder}</span>
                </div>
              </div>
            </div>
          </div>
        `;
        return fieldHTML;
      }

      case 'shippingOption': {
        const fontSizeNum = parseInt(globalFontSize.replace('px', '')) || 16;
        const smallerFontSize = Math.max(12, Math.round(fontSizeNum * 0.85)) + 'px';
        const shippingAlignment = field.shippingAlignment || 'right';
        
        const globalFontFamily = Utils.getFontFamily(settings);
        const shippingOptionStyle = `
          font-family: ${globalFontFamily} !important;
          font-size: ${globalFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          text-align: ${shippingAlignment};
        `;
        const shippingOptionItemStyle = `
          font-family: ${globalFontFamily} !important;
          font-size: ${smallerFontSize};
          font-weight: ${globalFontWeight};
          font-style: ${globalFontStyle};
          color: ${primaryColor};
          text-align: ${shippingAlignment};
        `;
        const stopDeskEnabled = shippingSettings && shippingSettings.stopDeskEnabled;
        const codLabel = shippingSettings && shippingSettings.codLabel ? shippingSettings.codLabel : 'التوصيل للمنزل';
        const stopDeskLabel = shippingSettings && shippingSettings.stopDeskLabel ? shippingSettings.stopDeskLabel : 'التوصيل للمكتب';
        
        const justifyContent = shippingAlignment === 'left' ? 'flex-start' : shippingAlignment === 'center' ? 'center' : 'space-between';

        fieldHTML = `
          <div class="leadcod-field" style="margin-bottom: 4px;">
            <div class="leadcod-shipping-section" style="display: none; --leadcod-primary-color: ${primaryColor};">
              <div style="${shippingOptionStyle}">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <label style="display: flex; align-items: center; justify-content: ${justifyContent}; gap: 12px; cursor: pointer; ${shippingOptionItemStyle}">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <input 
                        type="radio" 
                        name="${field.id}" 
                        value="cod"
                        ${field.required ? 'required' : ''}
                        style="width: 16px; height: 16px; cursor: pointer; accent-color: ${primaryColor};"
                      />
                      <span style="text-align: ${shippingAlignment}; font-family: ${globalFontFamily} !important;">${codLabel}</span>
                    </div>
                    <span class="leadcod-shipping-price-cod" style="font-weight: 600; font-size: ${smallerFontSize}; text-align: ${shippingAlignment}; font-family: ${globalFontFamily} !important;" data-price="0">-</span>
                  </label>
                  ${stopDeskEnabled ? `
                  <label style="display: flex; align-items: center; justify-content: ${justifyContent}; gap: 12px; cursor: pointer; ${shippingOptionItemStyle}">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <input 
                        type="radio" 
                        name="${field.id}" 
                        value="stopDesk"
                        ${field.required ? 'required' : ''}
                        style="width: 16px; height: 16px; cursor: pointer; accent-color: ${primaryColor};"
                      />
                      <span style="text-align: ${shippingAlignment}; font-family: ${globalFontFamily} !important;">${stopDeskLabel}</span>
                    </div>
                    <span class="leadcod-shipping-price-stopdesk" style="font-weight: 600; font-size: ${smallerFontSize}; text-align: ${shippingAlignment}; font-family: ${globalFontFamily} !important;" data-price="0">-</span>
                  </label>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
        return fieldHTML;
      }

      case 'buyButton':
        return window.LeadcodFormFields.renderBuyButton(field, settings, shippingSettings);

      case 'whatsappButton':
        return window.LeadcodFormFields.renderWhatsAppButton(field, settings, shippingSettings);

      default:
        return '<div class="leadcod-field" style="margin-bottom: 4px;"><div style="color: #ef4444;">Unknown field type: ' + field.type + '</div></div>';
    }

    if (!isPhoneField) {
      fieldHTML += '</div>';
    }
    fieldHTML += '</div>';
    return fieldHTML;
  };

  window.LeadcodFormFields.renderBuyButton = function(field, settings, shippingSettings) {
    const Utils = window.LeadcodFormUtils;
    const buttonGlobalFontSize = Utils.getGlobalFontSize(settings);
    const buttonGlobalFontStyle = Utils.getGlobalFontStyle(settings);
    const buttonFontSize = field.buttonFontSize || buttonGlobalFontSize;

    const buttonPadding = (() => {
      const fontSizeNum = parseInt(buttonFontSize.replace('px', '')) || 16;
      const verticalPadding = Math.max(10, Math.round(fontSizeNum * 0.625));
      const horizontalPadding = Math.max(20, Math.round(fontSizeNum * 1.5));
      return `${verticalPadding}px ${horizontalPadding}px`;
    })();

    const buttonSize = field.buttonSize === 'extra-large' ? '56px'
      : field.buttonSize === 'large' ? '48px'
      : field.buttonSize === 'small' ? '32px'
      : '40px';

    const buttonHeightNum = parseInt(buttonSize.replace('px', '')) || 40;
    const buttonIconSize = field.buttonIconSize || Math.round(buttonHeightNum * 0.6);

    const textAlign = Utils.getTextAlign(field.inputAlignment || 'center');
    const textColor = field.inputTextColor || '#ffffff';

    let buttonStyle = `
      font-family: ${Utils.getFontFamily(settings)} !important;
      font-size: ${buttonFontSize};
      font-weight: bold;
      font-style: ${buttonGlobalFontStyle};
      text-align: ${textAlign};
      color: ${textColor};
      padding: ${buttonPadding};
      height: ${buttonSize};
      border: none;
      border-radius: 0.375rem;
      width: 100%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    `;

    if (field.animation === 'glow') {
      const glowColor = Utils.extractGlowColor(field);
      let rgbaColor = glowColor;
      if (glowColor.startsWith('#')) {
        const hex = glowColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        rgbaColor = `rgba(${r}, ${g}, ${b}, 0.6)`;
      } else if (glowColor.startsWith('rgb(')) {
        rgbaColor = glowColor.replace('rgb(', 'rgba(').replace(')', ', 0.6)');
      } else if (!glowColor.startsWith('rgba(')) {
        rgbaColor = `rgba(0, 0, 0, 0.3)`;
      }
      buttonStyle += `--glow-color: ${rgbaColor};`;
    }

    const solidColor = field.inputBackgroundColor || '#000000';
    
    if (field.backgroundType === 'gradient' && field.gradientBackground) {
      if (field.animation === 'background-shift') {
        buttonStyle += `background-image: ${field.gradientBackground} !important; background-size: 200% 200% !important;`;
      } else {
        buttonStyle += `background-image: ${field.gradientBackground} !important;`;
      }
    } else {
      if (field.animation === 'background-shift') {
        const hex = solidColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        const isDark = r < 30 && g < 30 && b < 30;

        if (isDark) {
          const rgbaBase = Utils.colorToRgba(solidColor, 1);
          const rgbaMid = Utils.colorToRgba('#404040', 1);
          const rgbaLight = Utils.colorToRgba('#606060', 1);
          buttonStyle += `background-image: linear-gradient(135deg, ${rgbaBase} 0%, ${rgbaMid} 25%, ${rgbaLight} 50%, ${rgbaMid} 75%, ${rgbaBase} 100%) !important; background-size: 200% 200% !important;`;
        } else {
          const lighterColor = Utils.lightenColor(solidColor, 25);
          const rgbaBase = Utils.colorToRgba(solidColor, 1);
          const rgbaLight = Utils.colorToRgba(lighterColor, 0.8);
          const rgbaSemiTransparent = Utils.colorToRgba(solidColor, 0.7);
          buttonStyle += `background-image: linear-gradient(135deg, ${rgbaBase} 0%, ${rgbaSemiTransparent} 25%, ${rgbaLight} 50%, ${rgbaSemiTransparent} 75%, ${rgbaBase} 100%) !important; background-size: 200% 200% !important;`;
        }
      } else {
        buttonStyle += `background-color: ${solidColor} !important;`;
      }
    }

    const animations = {
      'background-shift': 'animation: backgroundShift 4s ease infinite !important; will-change: background-position;',
      'shake': 'animation: shake 0.6s ease-in-out infinite !important; will-change: transform; transform-origin: center;',
      'bounce': 'animation: bounce 1s ease-in-out infinite !important; will-change: transform; transform-origin: center;',
      'pulse': 'animation: pulse 2s ease-in-out infinite !important; will-change: transform, opacity; transform-origin: center;',
      'glow': 'animation: glow 2s ease-in-out infinite !important; will-change: box-shadow;'
    };

    if (field.animation && animations[field.animation]) {
      buttonStyle += animations[field.animation];
    }

    const buttonIcon = field.icon && field.icon !== 'none' ? field.icon : 'ArrowRight';
    const buttonIconHTML = Utils.renderIcon(buttonIcon, buttonIconSize);

    const showQuantity = field.showQuantity !== false;
    
    let quantityHTML = '';
    if (showQuantity) {
      const globalFontFamily = Utils.getFontFamily(settings);
      quantityHTML = `
        <div class="leadcod-quantity-selector" style="width: 100%; margin-bottom: 12px;">
          <button type="button" class="leadcod-quantity-button" data-action="decrease" style="font-family: ${globalFontFamily} !important;">-</button>
          <input type="number" name="quantity" value="1" min="1" class="leadcod-quantity-value" style="border: none; background: transparent; text-align: center; min-width: 60px; font-weight: 600; font-size: 18px; font-family: ${globalFontFamily} !important;">
          <button type="button" class="leadcod-quantity-button" data-action="increase" style="font-family: ${globalFontFamily} !important;">+</button>
        </div>
      `;
    } else {
      quantityHTML = '<input type="hidden" name="quantity" value="1">';
    }
    
    return `
      <div class="leadcod-field" style="margin-bottom: 0;">
        ${quantityHTML}
        <button type="submit" class="leadcod-confirm-button" style="${buttonStyle}">
          ${field.label}
          ${buttonIconHTML}
        </button>
      </div>
    `;
  };

  window.LeadcodFormFields.renderWhatsAppButton = function(field, settings, shippingSettings) {
    const Utils = window.LeadcodFormUtils;
    const buttonGlobalFontSize = Utils.getGlobalFontSize(settings);
    const buttonGlobalFontStyle = Utils.getGlobalFontStyle(settings);
    const buttonFontSize = field.buttonFontSize || buttonGlobalFontSize;

    const buttonPadding = (() => {
      const fontSizeNum = parseInt(buttonFontSize.replace('px', '')) || 16;
      const verticalPadding = Math.max(10, Math.round(fontSizeNum * 0.625));
      const horizontalPadding = Math.max(20, Math.round(fontSizeNum * 1.5));
      return `${verticalPadding}px ${horizontalPadding}px`;
    })();

    const buttonSize = field.buttonSize === 'extra-large' ? '56px'
      : field.buttonSize === 'large' ? '48px'
      : field.buttonSize === 'small' ? '32px'
      : '40px';

    const buttonHeightNum = parseInt(buttonSize.replace('px', '')) || 40;
    const buttonIconSize = field.buttonIconSize || Math.round(buttonHeightNum * 0.6);

    const textAlign = Utils.getTextAlign(field.inputAlignment || 'center');
    const textColor = field.inputTextColor || '#ffffff';

    let buttonStyle = `
      font-family: ${Utils.getFontFamily(settings)} !important;
      font-size: ${buttonFontSize};
      font-weight: bold;
      font-style: ${buttonGlobalFontStyle};
      text-align: ${textAlign};
      color: ${textColor};
      padding: ${buttonPadding};
      height: ${buttonSize};
      border: none;
      border-radius: 0.375rem;
      width: 100%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    `;

    if (field.animation === 'glow') {
      const glowColor = Utils.extractGlowColor(field);
      let rgbaColor = glowColor;
      if (glowColor.startsWith('#')) {
        const hex = glowColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        rgbaColor = `rgba(${r}, ${g}, ${b}, 0.6)`;
      } else if (glowColor.startsWith('rgb(')) {
        rgbaColor = glowColor.replace('rgb(', 'rgba(').replace(')', ', 0.6)');
      } else if (!glowColor.startsWith('rgba(')) {
        rgbaColor = `rgba(0, 0, 0, 0.3)`;
      }
      buttonStyle += `--glow-color: ${rgbaColor};`;
    }

    const solidColor = field.inputBackgroundColor || '#25D366';
    
    if (field.backgroundType === 'gradient' && field.gradientBackground) {
      if (field.animation === 'background-shift') {
        buttonStyle += `background-image: ${field.gradientBackground} !important; background-size: 200% 200% !important;`;
      } else {
        buttonStyle += `background-image: ${field.gradientBackground} !important;`;
      }
    } else {
      if (field.animation === 'background-shift') {
        const hex = solidColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        const isDark = r < 30 && g < 30 && b < 30;

        if (isDark) {
          const rgbaBase = Utils.colorToRgba(solidColor, 1);
          const rgbaMid = Utils.colorToRgba('#404040', 1);
          const rgbaLight = Utils.colorToRgba('#606060', 1);
          buttonStyle += `background-image: linear-gradient(135deg, ${rgbaBase} 0%, ${rgbaMid} 25%, ${rgbaLight} 50%, ${rgbaMid} 75%, ${rgbaBase} 100%) !important; background-size: 200% 200% !important;`;
        } else {
          const lighterColor = Utils.lightenColor(solidColor, 25);
          const rgbaBase = Utils.colorToRgba(solidColor, 1);
          const rgbaLight = Utils.colorToRgba(lighterColor, 0.8);
          const rgbaSemiTransparent = Utils.colorToRgba(solidColor, 0.7);
          buttonStyle += `background-image: linear-gradient(135deg, ${rgbaBase} 0%, ${rgbaSemiTransparent} 25%, ${rgbaLight} 50%, ${rgbaSemiTransparent} 75%, ${rgbaBase} 100%) !important; background-size: 200% 200% !important;`;
        }
      } else {
        buttonStyle += `background-color: ${solidColor} !important;`;
      }
    }

    const animations = {
      'background-shift': 'animation: backgroundShift 4s ease infinite !important; will-change: background-position;',
      'shake': 'animation: shake 0.6s ease-in-out infinite !important; will-change: transform; transform-origin: center;',
      'bounce': 'animation: bounce 1s ease-in-out infinite !important; will-change: transform; transform-origin: center;',
      'pulse': 'animation: pulse 2s ease-in-out infinite !important; will-change: transform, opacity; transform-origin: center;',
      'glow': 'animation: glow 2s ease-in-out infinite !important; will-change: box-shadow;'
    };

    if (field.animation && animations[field.animation]) {
      buttonStyle += animations[field.animation];
    }

    const buttonIcon = field.icon && field.icon !== 'none' ? field.icon : 'WhatsApp';
    const buttonIconHTML = Utils.renderIcon(buttonIcon, buttonIconSize);
    
    const whatsappNumber = field.whatsappNumber || '213000000000';
    
    return `
      <div class="leadcod-field" style="margin-bottom: 0;">
        <button type="button" class="leadcod-whatsapp-button" onclick="const form = this.closest('form'); if(form) { const formData = new FormData(form); const data = Object.fromEntries(formData); const message = encodeURIComponent('طلب جديد: ' + JSON.stringify(data)); window.open('https://wa.me/${whatsappNumber}?text=' + message, '_blank'); }" style="${buttonStyle}">
          ${field.label}
          ${buttonIconHTML}
        </button>
      </div>
    `;
  };
})();
</script>

