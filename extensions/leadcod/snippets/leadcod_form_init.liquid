{% comment %}
  Leadcod Form - Initialization Script
  Main script to fetch form data and render the form
{% endcomment %}
{% render 'leadcod_config' %}
{% comment %} Ensure API URL is set, fallback to config value if not available {% endcomment %}
{% unless LEADCOD_API_URL %}
  {% assign LEADCOD_API_URL = "https://9b1a587349e8.ngrok-free.app/api/form" %}
{% endunless %}
<script>
(function() {
  const container = document.getElementById('leadcod-form-{{ block.id }}');
  if (!container) return;

  const shopUrl = '{{ shop.domain }}';
  const apiUrl = '{{ LEADCOD_API_URL }}';
  
  console.log(`${apiUrl}?shop=${encodeURIComponent(shopUrl)}`);
  
  // Fetch form data
  fetch(`${apiUrl}?shop=${encodeURIComponent(shopUrl)}`)
    .then(async response => {
      console.log(response);
      return response.json();
    })
    .then(result => {
      if (!result.success || !result.data) {
        container.innerHTML = `<div class="leadcod-form-error">Form not found. Please configure your form in the app.${result.error ? ' (' + result.error + ')' : ''}</div>`;
        return;
      }

      const { fields, settings, shippingSettings } = result.data;
      renderForm(container, fields, settings, shippingSettings);
    })
    .catch(error => {
      console.error('Error loading form:', error);
      container.innerHTML = `<div class="leadcod-form-error">Error loading form: ${error.message}. Please check your API URL configuration.</div>`;
    });

  function renderForm(container, fields, settings, shippingSettings) {
    const Utils = window.LeadcodFormUtils;
    const Fields = window.LeadcodFormFields;
    
    // Filter visible fields and sort by order
    // Also filter out shippingOption if shipping method is 'free'
    const visibleFields = fields
      .filter(field => {
        if (!field.visible) return false;
        // Hide shippingOption if shipping method is 'free'
        if (field.type === 'shippingOption' && shippingSettings && shippingSettings.method === 'free') {
          return false;
        }
        return true;
      })
      .sort((a, b) => (a.order || 0) - (b.order || 0));

    const borderStyle = Utils.getBorderStyle(settings);
    let formHTML = `<form class="leadcod-form" style="max-width: 100%;${borderStyle}">`;

    // Global settings - headline and subtitle
    if (settings) {
      const primaryColor = Utils.getPrimaryColor(settings);
      if (settings.headline && settings.headline.enabled) {
        formHTML += `
          <h2 style="
            font-family: ${Utils.getFontFamily(settings)}; font-size: 24px; font-weight: bold; font-style: ${Utils.getGlobalFontStyle(settings)}; text-align: ${Utils.getTextAlign(settings.headline.alignment || 'center')};
            color: ${primaryColor};
            margin: 0 0 4px 0;
          ">${settings.headline.text || 'Order Form'}</h2>
        `;
      }

      if (settings.subtitle && settings.subtitle.enabled) {
        formHTML += `
          <p style="
            font-family: ${Utils.getFontFamily(settings)}; font-size: ${Utils.getGlobalFontSize(settings)}; font-weight: ${Utils.getGlobalFontWeight(settings)}; font-style: ${Utils.getGlobalFontStyle(settings)}; text-align: ${Utils.getTextAlign(settings.subtitle.alignment || 'center')};
            color: ${primaryColor};
            opacity: 0.7;
            margin: 0 0 8px 0;
          ">${settings.subtitle.text || 'Please fill out the form below'}</p>
        `;
      }
    }

    // Render fields
    if (visibleFields.length === 0) {
      formHTML += '<div style="text-align: center; padding: 32px; color: #6b7280;">No visible fields</div>';
    } else {
      visibleFields.forEach(field => {
        formHTML += Fields.renderField(field, settings, shippingSettings);
      });
    }

    formHTML += '</form>';

    container.innerHTML = formHTML;

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // Load states and cities
    loadStatesAndCities(container, apiUrl);

    // Add form submission handler
    const form = container.querySelector('.leadcod-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log('Form submitted:', data);
        // TODO: Handle form submission
        alert('Form submitted! (This is a demo)');
      });
    }
  }

  function loadStatesAndCities(container, apiUrl) {
    const baseApiUrl = apiUrl.replace('/form', '');
    const provinceSelect = container.querySelector('.leadcod-province-select');
    const cityField = container.querySelector('.leadcod-city-select');
    const shippingSection = container.querySelector('.leadcod-shipping-section');
    
    if (!provinceSelect) return;

    // Track if this is the initial render
    let isInitialRender = true;

    // Function to check if shipping section should be shown
    function updateShippingSectionVisibility() {
      const selectedProvince = provinceSelect.value;
      const selectedCity = cityField ? cityField.value : '';
      
      if (shippingSection) {
        if (selectedProvince && selectedCity) {
          // Show the section
          shippingSection.style.display = 'block';
          
          // Only animate on initial render (first time both are selected)
          if (isInitialRender) {
            // Set initial animation state
            shippingSection.style.opacity = '0';
            shippingSection.style.transform = 'translateY(-10px)';
            shippingSection.style.maxHeight = '0';
            shippingSection.style.marginBottom = '0';
            // Force reflow
            void shippingSection.offsetWidth;
            // Remove any existing animation class first
            shippingSection.classList.remove('show');
            // Force reflow again to restart animation
            void shippingSection.offsetWidth;
            // Add show class with animation
            shippingSection.classList.add('show');
            isInitialRender = false;
          } else {
            // Just show without animation (subsequent changes)
            shippingSection.style.opacity = '1';
            shippingSection.style.transform = 'translateY(0)';
            shippingSection.style.maxHeight = '';
            shippingSection.style.marginBottom = '';
            shippingSection.classList.add('show');
          }
        } else {
          shippingSection.classList.remove('show');
          // Reset styles and hide after animation
          setTimeout(() => {
            if (!shippingSection.classList.contains('show')) {
              shippingSection.style.display = 'none';
              shippingSection.style.opacity = '';
              shippingSection.style.transform = '';
              shippingSection.style.maxHeight = '';
              shippingSection.style.marginBottom = '';
            }
          }, 400);
        }
      }
    }

    // Function to create loader element
    function createLoader() {
      const loader = document.createElement('span');
      loader.className = 'leadcod-price-loader';
      loader.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-left: 4px;">
          <circle cx="6" cy="6" r="5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="8 4" opacity="0.6">
            <animateTransform attributeName="transform" type="rotate" from="0 6 6" to="360 6 6" dur="0.8s" repeatCount="indefinite"/>
          </circle>
        </svg>
      `;
      loader.style.display = 'inline-block';
      loader.style.verticalAlign = 'middle';
      loader.style.marginLeft = '4px';
      loader.style.color = '#6b7280';
      return loader;
    }

    // Function to fetch and update shipping prices
    function updateShippingPrices(stateId, showLoader = false) {
      if (!shippingSection || !stateId) {
        return;
      }

      const codPriceElement = shippingSection.querySelector('.leadcod-shipping-price-cod');
      const stopDeskPriceElement = shippingSection.querySelector('.leadcod-shipping-price-stopdesk');

      // Remove existing loaders
      const existingCodLoader = shippingSection.querySelector('.leadcod-price-loader-cod');
      const existingStopDeskLoader = shippingSection.querySelector('.leadcod-price-loader-stopdesk');
      if (existingCodLoader) existingCodLoader.remove();
      if (existingStopDeskLoader) existingStopDeskLoader.remove();

      // Show loader next to price elements only if requested
      if (showLoader) {
        if (codPriceElement) {
          const codLoader = createLoader();
          codLoader.className = 'leadcod-price-loader leadcod-price-loader-cod';
          codPriceElement.appendChild(codLoader);
        }
        if (stopDeskPriceElement) {
          const stopDeskLoader = createLoader();
          stopDeskLoader.className = 'leadcod-price-loader leadcod-price-loader-stopdesk';
          stopDeskPriceElement.appendChild(stopDeskLoader);
        }
      }

      // Fetch shipping fees
      fetch(`${baseApiUrl}/shipping-fees?shopUrl=${encodeURIComponent(shopUrl)}&stateId=${encodeURIComponent(stateId)}`)
        .then(response => response.json())
        .then(result => {
          // Remove loaders (only if they were shown)
          const codLoader = shippingSection.querySelector('.leadcod-price-loader-cod');
          const stopDeskLoader = shippingSection.querySelector('.leadcod-price-loader-stopdesk');
          if (codLoader) codLoader.remove();
          if (stopDeskLoader) stopDeskLoader.remove();

          if (result.success && result.data) {
            // Update COD price
            if (codPriceElement) {
              const codPrice = result.data.cashOnDelivery;
              if (codPrice !== null && codPrice !== undefined) {
                codPriceElement.textContent = codPrice + ' DZD';
              } else {
                codPriceElement.textContent = 'Free';
              }
            }

            // Update Stop Desk price
            if (stopDeskPriceElement) {
              const stopDeskPrice = result.data.stopDesk;
              if (stopDeskPrice !== null && stopDeskPrice !== undefined) {
                stopDeskPriceElement.textContent = stopDeskPrice + ' DZD';
              } else {
                stopDeskPriceElement.textContent = 'Free';
              }
            }
          } else {
            // Set default prices on error
            if (codPriceElement) codPriceElement.textContent = '-';
            if (stopDeskPriceElement) stopDeskPriceElement.textContent = '-';
          }
        })
        .catch(error => {
          console.error('Error fetching shipping fees:', error);
          // Remove loaders on error (only if they were shown)
          const codLoader = shippingSection.querySelector('.leadcod-price-loader-cod');
          const stopDeskLoader = shippingSection.querySelector('.leadcod-price-loader-stopdesk');
          if (codLoader) codLoader.remove();
          if (stopDeskLoader) stopDeskLoader.remove();
          
          if (codPriceElement) codPriceElement.textContent = '-';
          if (stopDeskPriceElement) stopDeskPriceElement.textContent = '-';
        });
    }

    // Fetch states
    fetch(`${baseApiUrl}/states`)
      .then(response => response.json())
      .then(result => {
        if (result.success && result.data) {
          // Clear loading option - use placeholder from field if available
          const placeholder = provinceSelect.getAttribute('data-placeholder') || 'Select province';
          provinceSelect.innerHTML = `<option value="">${placeholder}</option>`;
          
          // Populate states
          result.data.forEach(state => {
            const option = document.createElement('option');
            option.value = state.id;
            option.textContent = `${state.name} - ${state.nameAr} (${state.code})`;
            provinceSelect.appendChild(option);
          });

          // Enable the select and restore normal styling
          provinceSelect.disabled = false;
          provinceSelect.style.opacity = '1';
          provinceSelect.style.cursor = 'pointer';
          provinceSelect.style.backgroundColor = '';

          // Add change listener to province select
          provinceSelect.addEventListener('change', function() {
            const selectedStateId = this.value;
            
            // Hide shipping section when province changes
            updateShippingSectionVisibility();
            
            if (cityField) {
              if (selectedStateId) {
                // Fetch cities for selected state
                cityField.disabled = true;
                cityField.style.opacity = '0.6';
                cityField.style.cursor = 'not-allowed';
                cityField.style.backgroundColor = '#f9fafb';
                const placeholder = cityField.getAttribute('data-placeholder') || 'Select city';
                cityField.innerHTML = `<option value="">${placeholder}</option>`;
                
                // Fetch shipping prices for the selected province (show loader)
                updateShippingPrices(selectedStateId, true);
                
                fetch(`${baseApiUrl}/cities?stateId=${selectedStateId}`)
                  .then(response => response.json())
                  .then(result => {
                    if (result.success && result.data) {
                      cityField.innerHTML = `<option value="">${placeholder}</option>`;
                      result.data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = `${city.name} - ${city.nameAr}`;
                        cityField.appendChild(option);
                      });
                      cityField.disabled = false;
                      cityField.style.opacity = '1';
                      cityField.style.cursor = 'pointer';
                      cityField.style.backgroundColor = '';
                    } else {
                      cityField.innerHTML = '<option value="">Error loading cities</option>';
                      cityField.style.opacity = '0.6';
                    }
                  })
                  .catch(error => {
                    console.error('Error fetching cities:', error);
                    cityField.innerHTML = '<option value="">Error loading cities</option>';
                    cityField.style.opacity = '0.6';
                  });
              } else {
                // Clear city dropdown
                cityField.innerHTML = '<option value="">Select province first</option>';
                cityField.disabled = true;
                cityField.style.opacity = '0.6';
                cityField.style.cursor = 'not-allowed';
                cityField.style.backgroundColor = '#f9fafb';
                updateShippingSectionVisibility();
              }
            }
          });

          // Add change listener to city select
          if (cityField) {
            cityField.addEventListener('change', function() {
              const selectedStateId = provinceSelect.value;
              const selectedCity = this.value;
              
              // Show/hide shipping section (will animate only on initial render)
              updateShippingSectionVisibility();
              
              // Note: Prices don't need to be refetched when city changes since they're based on state
              // The prices are already loaded when the state was selected
            });
          }
        } else {
          provinceSelect.innerHTML = '<option value="">Error loading provinces</option>';
        }
      })
      .catch(error => {
        console.error('Error fetching states:', error);
        provinceSelect.innerHTML = '<option value="">Error loading provinces</option>';
      });
  }
})();
</script>


