{% assign LEADCOD_API_URL = 'https://65434dd7055b.ngrok-free.app/api/form' %}
<script>
(function() {
  'use strict';

  const container = document.getElementById('leadcod-form-{{ block.id }}');
  if (!container) return;

  const shopUrl = '{{ shop.domain }}';
  const apiUrl = '{{ LEADCOD_API_URL }}';
  fetch(`${apiUrl}?shop=${encodeURIComponent(shopUrl)}`)
    .then(response => response.json())
    .then(result => {
      if (!result.success || !result.data) {
        container.innerHTML = `<div class="leadcod-form-error">Form not found. Please configure your form in the app.${result.error ? ' (' + result.error + ')' : ''}</div>`;
        return;
      }

      const { fields, settings, shippingSettings } = result.data;
      renderForm(container, fields, settings, shippingSettings);
    })
    .catch(error => {
      console.error('Error loading form:', error);
      container.innerHTML = `<div class="leadcod-form-error">Error loading form: ${error.message}. Please check your API URL configuration.</div>`;
    });

  function renderForm(container, fields, settings, shippingSettings) {
    const Utils = window.LeadcodFormUtils;
    const Fields = window.LeadcodFormFields;

    // Phone validation function - accessible throughout renderForm
    const validatePhone = (phone, field) => {
      if (!phone) return null;
      const trimmed = phone.trim();
      
      // Get custom error messages or use defaults (Arabic)
      const errorNumbersOnly = (field && field.phoneErrorNumbersOnly) ? field.phoneErrorNumbersOnly : 'يجب أن يحتوي رقم الهاتف على أرقام فقط';
      const errorInvalidPrefix = (field && field.phoneErrorInvalidPrefix) ? field.phoneErrorInvalidPrefix : 'يجب أن يبدأ رقم الهاتف بـ 05، 06، 07، 5، 6، أو 7';
      const errorWrongLength10 = (field && field.phoneErrorWrongLength10) ? field.phoneErrorWrongLength10 : 'يجب أن يكون رقم الهاتف 10 أرقام بالضبط عند البدء بـ 0';
      const errorWrongLength9 = (field && field.phoneErrorWrongLength9) ? field.phoneErrorWrongLength9 : 'يجب أن يكون رقم الهاتف 9 أرقام بالضبط عند البدء بـ 5، 6، أو 7';
      
      // Check if phone contains only numbers
      if (!/^\d+$/.test(trimmed)) {
        return errorNumbersOnly;
      }
      
      // Check if phone starts with 05, 06, 07, 5, 6, or 7
      const validPattern = /^(05|06|07|5|6|7)/;
      if (!validPattern.test(trimmed)) {
        return errorInvalidPrefix;
      }
      
      // If starts with 0 (05, 06, 07), must be 10 digits
      // If starts with 5, 6, or 7 (without 0), must be 9 digits
      if (trimmed.startsWith('0')) {
        if (trimmed.length !== 10) {
          return errorWrongLength10;
        }
      } else {
        if (trimmed.length !== 9) {
          return errorWrongLength9;
        }
      }
      
      return null;
    };

    // Check if buy button shows quantity selector
    const buyButton = fields.find(f => f.type === 'buyButton');
    const buyButtonOrder = buyButton ? (buyButton.order || 11) : 11;
    
    // Check if there's a visible quantity field that appears before the buy button
    const quantityField = fields.find(f => f.type === 'quantity' && f.visible);
    const quantityFieldOrder = quantityField ? (quantityField.order || 10) : null;
    const hasStandaloneQuantityBeforeButton = quantityFieldOrder !== null && quantityFieldOrder < buyButtonOrder;

    const visibleFields = fields
      .filter(field => {
        if (!field.visible) return false;
        // Always show quantity field if it's visible - order will determine its position
        return true;
      })
      .sort((a, b) => (a.order || 0) - (b.order || 0));

    let formHTML = `<form class="leadcod-form" style="max-width: 100%;">`;

    if (settings) {
      const primaryColor = Utils.getPrimaryColor(settings);

      formHTML += '<div class="leadcod-form-header">';

      if (settings.headline && settings.headline.enabled) {
        const headlineText = settings.headline.text || 'أضف معلوماتك في الأسفل للطلب';
        const headlineAlign = Utils.getTextAlign(settings.headline.alignment || 'center');
        formHTML += `
          <h2 style="
            font-family: ${Utils.getFontFamily(settings)} !important;
            font-size: ${Utils.getGlobalFontSize(settings)};
            font-weight: ${Utils.getGlobalFontWeight(settings)};
            font-style: ${Utils.getGlobalFontStyle(settings)};
            text-align: ${headlineAlign};
            color: ${primaryColor};
            margin: 0 0 6px 0;
          ">${headlineText}</h2>
        `;
      }

      if (settings.subtitle && settings.subtitle.enabled) {
        const subtitleText = settings.subtitle.text || 'Please fill out the form below';
        const subtitleAlign = Utils.getTextAlign(settings.subtitle.alignment || 'center');
        formHTML += `
          <p style="
            font-family: ${Utils.getFontFamily(settings)} !important;
            font-size: ${Utils.getGlobalFontSize(settings)};
            font-weight: ${Utils.getGlobalFontWeight(settings)};
            font-style: ${Utils.getGlobalFontStyle(settings)};
            text-align: ${subtitleAlign};
            color: ${primaryColor};
            opacity: 0.7;
            margin: 0 0 0 0;
          ">${subtitleText}</p>
        `;
      }

      formHTML += '</div>';
    }

    if (visibleFields.length === 0) {
      formHTML += '<div style="text-align: center; padding: 32px; color: #6b7280;">No visible fields</div>';
    } else {
      // Render fields in order, grouping consecutive grid fields together
      let currentGridGroup = [];
      let inGridSection = false;
      
      visibleFields.forEach((field, index) => {
        const isFullWidth = field.type === 'summary' || field.type === 'buyButton' || field.type === 'whatsappButton' || field.type === 'shippingOption';
        
        if (isFullWidth) {
          // Close any open grid section before rendering full-width field
          if (inGridSection && currentGridGroup.length > 0) {
            currentGridGroup.forEach(gridField => {
              formHTML += Fields.renderField(gridField, settings, shippingSettings);
            });
            formHTML += '</div>';
            formHTML += '</div>';
            currentGridGroup = [];
            inGridSection = false;
          }
          
          // Render full-width field
          // If this is a buyButton and there's a standalone quantity field before it, don't show quantity in button
          if (field.type === 'buyButton' && hasStandaloneQuantityBeforeButton) {
            const fieldCopy = { ...field, showQuantity: false };
            formHTML += Fields.renderField(fieldCopy, settings, shippingSettings);
          } else if (field.type === 'shippingOption') {
            formHTML += '<div class="leadcod-form-section" style="display: none;">';
            formHTML += Fields.renderField(field, settings, shippingSettings);
            formHTML += '</div>';
          } else if (field.type === 'summary') {
            formHTML += '<div class="leadcod-form-section">';
            formHTML += Fields.renderField(field, settings, shippingSettings);
            formHTML += '</div>';
          } else {
            formHTML += Fields.renderField(field, settings, shippingSettings);
          }
        } else {
          // This is a grid field
          if (!inGridSection) {
            // Start a new grid section
            formHTML += '<div class="leadcod-form-section">';
            formHTML += '<div class="leadcod-fields-grid">';
            inGridSection = true;
          }
          currentGridGroup.push(field);
        }
      });
      
      // Close any remaining grid section
      if (inGridSection && currentGridGroup.length > 0) {
        currentGridGroup.forEach(gridField => {
          formHTML += Fields.renderField(gridField, settings, shippingSettings);
        });
        formHTML += '</div>';
        formHTML += '</div>';
      }
    }

    // Add hidden quantity input if quantity field is not visible
    const allQuantityField = fields.find(f => f.type === 'quantity');
    if (allQuantityField && !allQuantityField.visible) {
      formHTML += '<input type="hidden" name="' + allQuantityField.id + '" value="1">';
    }

    formHTML += '</form>';

    container.innerHTML = formHTML;

    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    initializeQuantitySelector(container);
    initializePhoneValidation(container, validatePhone, fields);

    container._shippingSettings = shippingSettings;
    container._settings = settings;
    container._fields = fields;

    loadStatesAndCities(container, apiUrl);
    initializeSummary(container);

    const form = container.querySelector('.leadcod-form');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Validate phone fields before submission
        const phoneInputs = container.querySelectorAll('.leadcod-phone-input');
        let hasPhoneError = false;
        phoneInputs.forEach(input => {
          const value = input.value;
          const fieldId = input.getAttribute('data-field-id');
          const phoneField = fields ? fields.find(f => f.id === fieldId && f.type === 'phone') : null;
          const error = validatePhone(value, phoneField);
          if (error && value.length > 0) {
            hasPhoneError = true;
            const errorElement = container.querySelector(`#error-${fieldId}`);
            if (errorElement) {
              errorElement.textContent = error;
              errorElement.style.display = 'block';
            }
            input.style.borderColor = '#ef4444';
            input.style.borderWidth = '2px';
          }
        });
        
        if (hasPhoneError) {
          return; // Prevent submission if phone validation fails
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        const provinceSelect = container.querySelector('.leadcod-province-select');
        const citySelect = container.querySelector('.leadcod-city-select');
        // Get IDs from select values (they are already set to state.id and city.id)
        const provinceId = provinceSelect?.value || '';
        const cityId = citySelect?.value || '';

        const productOrVariantId = new URLSearchParams(window.location.search).get('variant') || {{ product.selected_or_first_available_variant.id }};
        const variants = {{ product.variants | json }};
        const productData = variants.find(variant => variant.id === productOrVariantId);
        if (productData) {
          data.productId = productData.id;
        }

        let shippingType;
        const shippingSection = container.querySelector('.leadcod-shipping-section');
        const selectedShippingOption = shippingSection?.querySelector('input[type="radio"]:checked');
        if (selectedShippingOption) {
          shippingType = selectedShippingOption.value;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton?.innerHTML || '';
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = 'Processing...';
        }

        const baseApiUrl = apiUrl.replace('/form', '');
        const orderPayload = {
          shopUrl,
          name: data.name || '',
          phone: data.phone || '',
          cityId: cityId,
          provinceId: provinceId,
          productId: String(data.productId),
          ...(shippingType && { shippingType })
        };

        try {
          const response = await fetch(`${baseApiUrl}/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderPayload)
          });

          const result = await response.json();
          alert(result.success 
            ? 'Order created successfully!' 
            : 'Error creating order: ' + (result.error || 'Unknown error'));
          
          if (result.success) form.reset();
        } catch (error) {
          console.error('Error submitting order:', error);
          alert('Error submitting order: ' + error.message);
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        }
      });
    }
  }

  function initializeQuantitySelector(container) {
    const quantitySelectors = container.querySelectorAll('.leadcod-quantity-selector');
    
    quantitySelectors.forEach(selector => {
      const decreaseBtn = selector.querySelector('[data-action="decrease"]');
      const increaseBtn = selector.querySelector('[data-action="increase"]');
      // Find quantity input - could be name="quantity" (buy button) or name="quantity" (standalone field)
      const quantityInput = selector.querySelector('input[type="number"]');
      
      if (decreaseBtn && quantityInput) {
        decreaseBtn.addEventListener('click', function() {
          const currentValue = parseInt(quantityInput.value) || 1;
          if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
            quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
            quantityInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      }
      
      if (increaseBtn && quantityInput) {
        increaseBtn.addEventListener('click', function() {
          const currentValue = parseInt(quantityInput.value) || 1;
          quantityInput.value = currentValue + 1;
          quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
          quantityInput.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }
    });
  }

  function initializePhoneValidation(container, validatePhone, fields) {
    const phoneInputs = container.querySelectorAll('.leadcod-phone-input');
    
    phoneInputs.forEach(input => {
      const fieldId = input.getAttribute('data-field-id');
      const errorElement = container.querySelector(`#error-${fieldId}`);
      const phoneField = fields ? fields.find(f => f.id === fieldId && f.type === 'phone') : null;
      
      // Restrict input to numbers only and limit based on starting digit
      const restrictToNumbers = (e) => {
        const value = input.value;
        // Remove any non-numeric characters
        const numericValue = value.replace(/\D/g, '');
        // Limit based on starting digit: 10 if starts with 0, 9 otherwise
        let maxLength = 10;
        if (numericValue.length > 0 && !numericValue.startsWith('0')) {
          maxLength = 9;
        }
        const limitedValue = numericValue.slice(0, maxLength);
        
        // Update maxlength attribute dynamically
        input.setAttribute('maxlength', maxLength.toString());
        
        if (limitedValue !== value) {
          input.value = limitedValue;
        }
      };
      
      // Prevent non-numeric keys
      input.addEventListener('keydown', (e) => {
        const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
        if (!allowedKeys.includes(e.key) && !/^\d$/.test(e.key) && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
        }
      });
      
      // Clean input on input event
      input.addEventListener('input', restrictToNumbers);
      
      const validateAndShowError = () => {
        const value = input.value;
        const error = validatePhone(value, phoneField);
        
        if (error && value.length > 0) {
          // Show error
          if (errorElement) {
            errorElement.textContent = error;
            errorElement.style.display = 'block';
          }
          // Make border red
          input.style.borderColor = '#ef4444';
          input.style.borderWidth = '2px';
        } else {
          // Hide error
          if (errorElement) {
            errorElement.style.display = 'none';
          }
          // Reset border
          input.style.borderColor = '#e5e7eb';
          input.style.borderWidth = '1px';
        }
      };
      
      // Validate only on change event (when user leaves the field or presses Enter)
      input.addEventListener('change', validateAndShowError);
      input.addEventListener('blur', validateAndShowError);
    });
  }

  function initializeSummary(container) {
    const productOrVariantId = new URLSearchParams(window.location.search).get('variant') || {{ product.selected_or_first_available_variant.id }};
    const variants = {{ product.variants | json }};
    const product = {{ product | json }};
    
    const fields = container._fields;
    const settings = container._settings;
    const summaryField = fields ? fields.find(f => f.type === 'summary') : null;
    const summaryPlaceholder = summaryField && summaryField.summaryPlaceholder ? summaryField.summaryPlaceholder : '-';
    const totalLabel = summaryField && summaryField.totalLabel ? summaryField.totalLabel : 'المجموع';
    const shippingLabel = summaryField && summaryField.shippingLabel ? summaryField.shippingLabel : 'سعر الشحن';
    const chooseProvinceHint = summaryField && summaryField.chooseProvinceHint ? summaryField.chooseProvinceHint : 'اختر الولاية';
    const selectShippingOptionHint = summaryField && summaryField.selectShippingOptionHint ? summaryField.selectShippingOptionHint : 'اختر خيار الشحن';
    const summaryAlignment = summaryField && summaryField.summaryAlignment ? summaryField.summaryAlignment : 'right';
    
    const cityField = fields ? fields.find(f => f.type === 'city') : null;
    const provinceField = fields ? fields.find(f => f.type === 'province') : null;
    const shippingOptionField = fields ? fields.find(f => f.type === 'shippingOption') : null;
    const cityPlaceholder = cityField && cityField.showPlaceholder && cityField.placeholder ? cityField.placeholder : (cityField && cityField.label ? cityField.label : '-');
    const provincePlaceholder = provinceField && provinceField.showPlaceholder && provinceField.placeholder ? provinceField.placeholder : (provinceField && provinceField.label ? provinceField.label : '-');
    const shippingOptionLabel = shippingOptionField && shippingOptionField.label ? shippingOptionField.label : summaryPlaceholder;
    
    let currentVariant = variants.find(variant => variant.id === productOrVariantId) || variants[0];
    let currentQuantity = 1;
    let shippingPrice = 0;
    let selectedShippingMethodLabel = '';
    let shippingType = '';

    const summaryContentEl = container.querySelector('.leadcod-summary-content');
    const summaryItems = container.querySelectorAll('.leadcod-summary-item');
    const summaryTotal = container.querySelector('.leadcod-summary-total');
    const productNameEl = container.querySelector('.leadcod-product-name');
    const productPriceEl = container.querySelector('.leadcod-product-price');
    const shippingLabelEl = container.querySelector('.leadcod-shipping-label');
    const shippingHintEl = container.querySelector('.leadcod-shipping-hint');
    const shippingHintTextEl = container.querySelector('.leadcod-shipping-hint-text');
    const shippingPriceEl = container.querySelector('.leadcod-shipping-price');
    const totalLabelEl = container.querySelector('.leadcod-summary-total-label');
    const totalPriceEl = container.querySelector('.leadcod-total-price');
    
    if (summaryContentEl) {
      summaryContentEl.style.textAlign = summaryAlignment;
    }
    summaryItems.forEach(item => {
      item.style.textAlign = summaryAlignment;
    });
    if (summaryTotal) {
      summaryTotal.style.textAlign = summaryAlignment;
    }
    
    if (totalLabelEl) {
      totalLabelEl.textContent = totalLabel;
    }

    function formatPrice(price) {
      const settings = container._settings;
      const Utils = window.LeadcodFormUtils;
      const currency = Utils.getCurrency(settings) || 'DZD';
      return (price / 100).toFixed(0) + ' ' + currency;
    }

    function updateSummary() {
      if (productNameEl && currentVariant) {
        productNameEl.textContent = product.title || currentVariant.title || summaryPlaceholder;
      } else if (productNameEl) {
        productNameEl.textContent = summaryPlaceholder;
      }
      if (productPriceEl && currentVariant) {
        const price = currentVariant.price || 0;
        productPriceEl.textContent = `${formatPrice(price)} x${currentQuantity}`;
      } else if (productPriceEl) {
        productPriceEl.textContent = summaryPlaceholder;
      }

      const provinceSelect = container.querySelector('.leadcod-province-select');
      const citySelect = container.querySelector('.leadcod-city-select');
      const shippingSection = container.querySelector('.leadcod-shipping-section');
      const selectedShippingOption = shippingSection?.querySelector('input[type="radio"]:checked');

      if (!provinceSelect || !provinceSelect.value) {
        // Always show product name and price, even when no province is selected
        if (productNameEl && currentVariant) {
          productNameEl.textContent = product.title || currentVariant.title || summaryPlaceholder;
        } else if (productNameEl) {
          productNameEl.textContent = summaryPlaceholder;
        }
        if (productPriceEl && currentVariant) {
          const price = currentVariant.price || 0;
          productPriceEl.textContent = `${formatPrice(price)} x${currentQuantity}`;
        } else if (productPriceEl) {
          productPriceEl.textContent = summaryPlaceholder;
        }
        if (shippingLabelEl) shippingLabelEl.textContent = shippingLabel;
        if (shippingHintEl) shippingHintEl.style.display = 'flex';
        if (shippingHintTextEl) shippingHintTextEl.textContent = chooseProvinceHint;
        if (shippingPriceEl) shippingPriceEl.textContent = summaryPlaceholder;
        if (totalPriceEl && currentVariant) {
          const productPriceInCents = (currentVariant.price || 0) * currentQuantity;
          const productPriceInDZD = productPriceInCents / 100;
          const settings = container._settings;
          const Utils = window.LeadcodFormUtils;
          const currency = Utils.getCurrency(settings) || 'DZD';
          totalPriceEl.textContent = productPriceInDZD.toFixed(0) + ' ' + currency;
        } else if (totalPriceEl) {
          totalPriceEl.textContent = summaryPlaceholder;
        }
        shippingPrice = 0;
        selectedShippingMethodLabel = '';
        shippingType = '';
      } else if (!selectedShippingOption) {
        if (productNameEl && currentVariant) {
          productNameEl.textContent = product.title || currentVariant.title || summaryPlaceholder;
        }
        if (productPriceEl && currentVariant) {
          const price = currentVariant.price || 0;
          productPriceEl.textContent = `${formatPrice(price)} x${currentQuantity}`;
        }
        if (shippingLabelEl) shippingLabelEl.textContent = shippingLabel;
        if (shippingHintEl) shippingHintEl.style.display = 'flex';
        if (shippingHintTextEl) shippingHintTextEl.textContent = selectShippingOptionHint;
        if (shippingPriceEl) shippingPriceEl.textContent = summaryPlaceholder;
        if (totalPriceEl && currentVariant) {
          const productPriceInCents = (currentVariant.price || 0) * currentQuantity;
          const productPriceInDZD = productPriceInCents / 100;
          const settings = container._settings;
          const Utils = window.LeadcodFormUtils;
          const currency = Utils.getCurrency(settings) || 'DZD';
          totalPriceEl.textContent = productPriceInDZD.toFixed(0) + ' ' + currency;
        }
        shippingPrice = 0;
        selectedShippingMethodLabel = '';
        shippingType = '';
      } else {
        shippingType = selectedShippingOption.value;
        const priceSelector = shippingType === 'cod'
          ? '.leadcod-shipping-price-cod'
          : '.leadcod-shipping-price-stopdesk';
        const priceElement = shippingSection.querySelector(priceSelector);
        
        if (priceElement) {
          const priceAttr = priceElement.getAttribute('data-price');
          if (priceAttr !== null) {
            shippingPrice = parseInt(priceAttr, 10);
          }
          const labelSpan = selectedShippingOption.closest('label')?.querySelector('div span');
          if (labelSpan) {
            selectedShippingMethodLabel = labelSpan.textContent.trim();
          }
        }

        if (shippingLabelEl) shippingLabelEl.textContent = shippingLabel;
        if (shippingHintEl) shippingHintEl.style.display = 'none';
        if (shippingPriceEl) {
          const shippingSettings = container._shippingSettings;
          const settings = container._settings;
          const Utils = window.LeadcodFormUtils;
          const freeShippingLabel = shippingSettings && shippingSettings.freeShippingLabel ? shippingSettings.freeShippingLabel : 'Free';
          const currency = Utils.getCurrency(settings) || 'DZD';
          shippingPriceEl.textContent = shippingPrice > 0 ? shippingPrice + ' ' + currency : freeShippingLabel;
        }
      }

      if (totalPriceEl && currentVariant) {
        const productPriceInCents = (currentVariant.price || 0) * currentQuantity;
        const productPriceInDZD = productPriceInCents / 100;
        const total = productPriceInDZD + shippingPrice;
        const settings = container._settings;
        const Utils = window.LeadcodFormUtils;
        const currency = Utils.getCurrency(settings) || 'DZD';
        totalPriceEl.textContent = total.toFixed(0) + ' ' + currency;
      }
    }

    const variantSelect = container.querySelector('select[name*="variant"], select.leadcod-variant-select');
    if (variantSelect) {
      variantSelect.addEventListener('change', function() {
        const selectedVariantId = this.value;
        currentVariant = variants.find(v => String(v.id) === String(selectedVariantId)) || currentVariant;
        updateSummary();
      });
    }

    function checkVariantFromURL() {
      const urlVariantId = new URLSearchParams(window.location.search).get('variant');
      if (urlVariantId) {
        const urlVariant = variants.find(v => String(v.id) === String(urlVariantId));
        if (urlVariant) {
          currentVariant = urlVariant;
          updateSummary();
        }
      }
    }
    
    checkVariantFromURL();
    
    window.addEventListener('popstate', checkVariantFromURL);
    
    let lastVariantId = productOrVariantId;
    setInterval(() => {
      const currentVariantId = new URLSearchParams(window.location.search).get('variant') || {{ product.selected_or_first_available_variant.id }};
      if (String(currentVariantId) !== String(lastVariantId)) {
        lastVariantId = currentVariantId;
        const urlVariant = variants.find(v => String(v.id) === String(currentVariantId));
        if (urlVariant) {
          currentVariant = urlVariant;
          updateSummary();
        }
      }
    }, 500);

    // Find quantity input - could be from buy button or standalone quantity field
    const quantityInput = container.querySelector('input[name="quantity"], input#field-quantity');
    if (quantityInput) {
      quantityInput.addEventListener('change', function() {
        currentQuantity = parseInt(this.value) || 1;
        updateSummary();
      });
      quantityInput.addEventListener('input', function() {
        currentQuantity = parseInt(this.value) || 1;
        updateSummary();
      });
    }

    const shippingSection = container.querySelector('.leadcod-shipping-section');
    if (shippingSection) {
      const shippingRadios = shippingSection.querySelectorAll('input[type="radio"]');
      shippingRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          updateSummary();
        });
      });
    }

    const provinceSelect = container.querySelector('.leadcod-province-select');
    const citySelect = container.querySelector('.leadcod-city-select');
    if (provinceSelect) {
      provinceSelect.addEventListener('change', function() {
        setTimeout(updateSummary, 100);
      });
    }
    if (citySelect) {
      citySelect.addEventListener('change', function() {
        setTimeout(updateSummary, 100);
      });
    }

    container._updateSummary = updateSummary;

    updateSummary();
  }

    function loadStatesAndCities(container, apiUrl) {
    const baseApiUrl = apiUrl.replace('/form', '');
    const provinceSelect = container.querySelector('.leadcod-province-select');
    const cityField = container.querySelector('.leadcod-city-select');
    const shippingSection = container.querySelector('.leadcod-shipping-section');
    const shippingFormSection = shippingSection?.closest('.leadcod-form-section');

    if (!provinceSelect) return;
    
    const fields = container._fields;
    const cityFieldConfig = fields ? fields.find(f => f.type === 'city') : null;
    const provinceFieldConfig = fields ? fields.find(f => f.type === 'province') : null;
    const cityPlaceholder = cityFieldConfig && cityFieldConfig.showPlaceholder && cityFieldConfig.placeholder ? cityFieldConfig.placeholder : (cityFieldConfig && cityFieldConfig.label ? cityFieldConfig.label : '-');
    const citySelectProvinceFirstHint = cityFieldConfig && cityFieldConfig.selectProvinceFirstHint ? cityFieldConfig.selectProvinceFirstHint : 'اختر الولاية أولاً';
    const provincePlaceholder = provinceFieldConfig && provinceFieldConfig.showPlaceholder && provinceFieldConfig.placeholder ? provinceFieldConfig.placeholder : (provinceFieldConfig && provinceFieldConfig.label ? provinceFieldConfig.label : '-');

    let isInitialRender = true;

    function updateShippingSectionVisibility() {
      if (!shippingSection) return;

      const shouldShow = provinceSelect.value;

      if (shouldShow) {
        if (shippingFormSection) {
          shippingFormSection.style.display = 'block';
        }
        shippingSection.style.display = 'block';
        if (isInitialRender) {
          shippingSection.style.opacity = '0';
          shippingSection.style.transform = 'translateY(-10px)';
          shippingSection.style.maxHeight = '0';
          shippingSection.style.marginBottom = '0';
          void shippingSection.offsetWidth;
          shippingSection.classList.remove('show');
          void shippingSection.offsetWidth;
          shippingSection.classList.add('show');
          isInitialRender = false;
        } else {
          shippingSection.style.opacity = '1';
          shippingSection.style.transform = 'translateY(0)';
          shippingSection.style.maxHeight = '';
          shippingSection.style.marginBottom = '';
          shippingSection.classList.add('show');
        }
      } else {
        shippingSection.classList.remove('show');
        if (shippingFormSection) {
          shippingFormSection.style.display = 'none';
        }
        setTimeout(() => {
          if (!shippingSection.classList.contains('show')) {
            shippingSection.style.display = 'none';
            shippingSection.style.opacity = '';
            shippingSection.style.transform = '';
            shippingSection.style.maxHeight = '';
            shippingSection.style.marginBottom = '';
          }
        }, 400);
      }
    }

    function removeLoaders() {
      shippingSection?.querySelectorAll('.leadcod-price-loader').forEach(loader => loader.remove());
    }

    function createLoader(className) {
      const loader = document.createElement('span');
      loader.className = `leadcod-price-loader ${className}`;
      const svgHTML = '<svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-left: 4px;"><circle cx="6" cy="6" r="5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="8 4" opacity="0.6"><animateTransform attributeName="transform" type="rotate" from="0 6 6" to="360 6 6" dur="0.8s" repeatCount="indefinite"/></circle></svg>';
      loader.innerHTML = svgHTML;
      loader.style.cssText = 'display: inline-block; vertical-align: middle; margin-left: 4px; color: #6b7280;';
      return loader;
    }

    function updateShippingPrices(stateId, showLoader = false) {
      if (!shippingSection || !stateId) return;

      const codPriceElement = shippingSection.querySelector('.leadcod-shipping-price-cod');
      const stopDeskPriceElement = shippingSection.querySelector('.leadcod-shipping-price-stopdesk');

      removeLoaders();

      const shippingSettings = container._shippingSettings;
      const settings = container._settings;
      const Utils = window.LeadcodFormUtils;
      if (shippingSettings && shippingSettings.method === 'free') {
        const freeShippingLabel = shippingSettings.freeShippingLabel || 'Free';
        const currency = Utils.getCurrency(settings) || 'DZD';
        function updatePriceElement(element, price) {
          if (!element) return;
          if (price !== null && price !== undefined && price !== 0) {
            element.textContent = price + ' ' + currency;
            element.setAttribute('data-price', price.toString());
          } else {
            element.textContent = freeShippingLabel;
            element.setAttribute('data-price', '0');
          }
        }
        updatePriceElement(codPriceElement, 0);
        updatePriceElement(stopDeskPriceElement, 0);
        if (container._updateSummary) {
          setTimeout(() => container._updateSummary(), 100);
        }
        return;
      }

      if (showLoader) {
        if (codPriceElement) {
          codPriceElement.appendChild(createLoader('leadcod-price-loader-cod'));
        }
        if (stopDeskPriceElement) {
          stopDeskPriceElement.appendChild(createLoader('leadcod-price-loader-stopdesk'));
        }
      }

      function updatePriceElement(element, price) {
        if (!element) return;
        const shippingSettings = container._shippingSettings;
        const settings = container._settings;
        const Utils = window.LeadcodFormUtils;
        const freeShippingLabel = shippingSettings && shippingSettings.freeShippingLabel ? shippingSettings.freeShippingLabel : 'Free';
        const currency = Utils.getCurrency(settings) || 'DZD';
        if (price !== null && price !== undefined) {
          element.textContent = price + ' ' + currency;
          element.setAttribute('data-price', price.toString());
        } else {
          element.textContent = freeShippingLabel;
          element.setAttribute('data-price', '0');
        }
      }

      function setErrorPrice(element) {
        if (element) {
          element.textContent = '-';
          element.setAttribute('data-price', '0');
        }
      }

      fetch(`${baseApiUrl}/shipping-fees?shopUrl=${encodeURIComponent(shopUrl)}&stateId=${encodeURIComponent(stateId)}`)
        .then(response => response.json())
        .then(result => {
          removeLoaders();
          if (result.success && result.data) {
            updatePriceElement(codPriceElement, result.data.cashOnDelivery);
            updatePriceElement(stopDeskPriceElement, result.data.stopDesk);
          } else {
            setErrorPrice(codPriceElement);
            setErrorPrice(stopDeskPriceElement);
          }
          if (container._updateSummary) {
            setTimeout(() => container._updateSummary(), 100);
          }
        })
        .catch(error => {
          console.error('Error fetching shipping fees:', error);
          removeLoaders();
          setErrorPrice(codPriceElement);
          setErrorPrice(stopDeskPriceElement);
          if (container._updateSummary) {
            setTimeout(() => container._updateSummary(), 100);
          }
        });
    }

    function setFieldState(field, disabled, placeholder, isCityField = false) {
      field.disabled = disabled;
      field.style.opacity = disabled ? '0.6' : '1';
      field.style.cursor = disabled ? 'not-allowed' : 'pointer';
      field.style.backgroundColor = disabled ? '#f9fafb' : '';
      // Only reset innerHTML when disabling the field, not when enabling
      if (disabled && placeholder) {
        const displayPlaceholder = (isCityField && disabled && citySelectProvinceFirstHint) 
          ? citySelectProvinceFirstHint 
          : placeholder;
        field.innerHTML = `<option value="">${displayPlaceholder}</option>`;
      }
    }

    fetch(`${baseApiUrl}/states`)
      .then(response => response.json())
      .then(result => {
        if (result.success && result.data) {
          provinceSelect.innerHTML = `<option value="">${provincePlaceholder}</option>`;
          
          result.data.forEach(state => {
            const option = document.createElement('option');
            option.value = state.id;
            option.textContent = `${state.name} - ${state.nameAr} (${state.code})`;
            option.setAttribute('data-name', state.name);
            provinceSelect.appendChild(option);
          });

          setFieldState(provinceSelect, false);

          provinceSelect.addEventListener('change', function() {
            const selectedStateId = this.value;
            
            if (cityField) {
              cityField.value = '';
              
              if (selectedStateId) {
                setFieldState(cityField, true, cityPlaceholder, true);
                updateShippingPrices(selectedStateId, true);
                
                fetch(`${baseApiUrl}/cities?stateId=${selectedStateId}`)
                  .then(response => response.json())
                  .then(result => {
                    if (result.success && result.data) {
                      cityField.innerHTML = `<option value="">${cityPlaceholder}</option>`;
                      result.data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = `${city.name} - ${city.nameAr}`;
                        option.setAttribute('data-name', city.name);
                        cityField.appendChild(option);
                      });
                      setFieldState(cityField, false, cityPlaceholder, true);
                    } else {
                      cityField.innerHTML = `<option value="">${cityPlaceholder}</option>`;
                      cityField.style.opacity = '0.6';
                    }
                    updateShippingSectionVisibility();
                  })
                  .catch(error => {
                    console.error('Error fetching cities:', error);
                    cityField.innerHTML = `<option value="">${cityPlaceholder}</option>`;
                    cityField.style.opacity = '0.6';
                    updateShippingSectionVisibility();
                  });
              } else {
                setFieldState(cityField, true, cityPlaceholder, true);
                updateShippingSectionVisibility();
              }
            } else {
              updateShippingSectionVisibility();
            }
          });

          if (cityField) {
            cityField.addEventListener('change', updateShippingSectionVisibility);
          }
          
          updateShippingSectionVisibility();
        } else {
          provinceSelect.innerHTML = `<option value="">${provincePlaceholder}</option>`;
        }
      })
      .catch(error => {
        console.error('Error fetching states:', error);
        provinceSelect.innerHTML = `<option value="">${provincePlaceholder}</option>`;
      });
  }
})();
</script>

